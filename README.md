# Kitty Enc - 文件加密工具

一个用 Rust 编写的简单的文件加密工具，支持密钥文件和纯密码两种加密模式。

## 快速开始

### 编译环境设置(有需要的话)
```powershell
$env:RUSTFLAGS="-C target-feature=+crt-static"
$env:RUSTFLAGS="-C target-cpu=native"
```

### 基本用法
```bash
kitty_enc [OPTIONS] [COMMAND]
```

## 命令(不建议使用子命令)

| 命令 | 描述 |
|------|------|
| `encrypt` | 加密模式 |
| `decrypt` | 解密模式 |
| `msg` | 消息模式 |
| `base` | 编码模式 |
| `help` | 显示帮助信息 |

## 选项(推荐直接使用选项)

| 选项 | 参数 | 描述 |
|------|------|------|
| `-k, --key` | `<KEY_FILE>` | 密钥文件路径（可选）。如果指定，则使用该密钥文件；如果不指定，程序会自动查找或生成密钥文件 |
| `-a, --any-file` | `<FILE>` | 任意文件作为密钥源（可选）。使用指定文件的内容派生密钥，与-p同时使用表示使用密码 |
| `-s, --src` | `<DIR>` | 要加密的目录路径。加密时会优先在该目录中查找密钥文件，默认为当前目录 |
| `-d, --dec` | `<DIR>` | 要解密的目录路径。解密时会优先在该目录中查找密钥文件，默认为当前目录 |
| `-p, --passwd` | | 使用纯密码模式，不生成密钥文件，与-a同时使用表示使用密码 |
| `-f, --fix` | `<DIR>` | 要修复的目录路径。修复时会收集该目录下的所有文件进行比对，默认为当前目录 |
| `-r, --recursive` | `<DEPTH>` | 是否递归文件夹, 可指定递归深度, 0或默认为无限递归 |
| `-h, --help` | | 显示帮助信息 |
| `-V, --version` | | 显示版本信息 |

## 使用示例

### 基本操作
```bash
# 无参数：在当前目录生成密钥并加密当前目录（默认使用密码短语）
kitty_enc

# 加密指定目录（优先在 DIR 中查找密钥，没有则生成，默认使用密码短语）
kitty_enc -s DIR

# 使用指定密钥加密指定目录（默认使用密码短语）
kitty_enc -k key.kitty_key -s DIR

# 显式加密指定目录（优先在 DIR 中查找密钥，没有则生成，默认使用密码短语）
kitty_enc encrypt -s DIR
```

### 解密操作
```bash
# 解密指定目录（在 DIR 中查找密钥文件，默认使用密码短语）
kitty_enc -d DIR

# 使用指定密钥解密指定目录（默认使用密码短语）
kitty_enc -k key.kitty_key -d DIR

# 显式解密指定目录（在 DIR 中查找密钥文件，默认使用密码短语）
kitty_enc decrypt -d DIR
```

### 纯密码模式
```bash
# 纯密码模式：使用密码加密当前目录（不生成密钥文件）
kitty_enc -p

# 纯密码模式：使用密码加密指定目录（不生成密钥文件）
kitty_enc -p -s DIR

# 纯密码模式：使用密码解密指定目录（不生成密钥文件）
kitty_enc -p -d DIR
```

### 任意文件模式
```bash
# 任意文件模式：使用指定文件派生密钥加密目录
kitty_enc -a FILE -s DIR

# 任意文件模式：使用指定文件派生密钥解密目录
kitty_enc -a FILE -d DIR

# 任意文件模式+密码：使用文件内容和密码派生密钥加密目录
kitty_enc -a FILE -p -s DIR

# 任意文件模式+密码：使用文件内容和密码派生密钥解密目录
kitty_enc -a FILE -p -d DIR
```

### 修复模式
```bash
# 修复指定目录
kitty_enc -f DIR

# 使用指定密钥修复指定目录
kitty_enc -k key.kitty_key -f DIR

# 纯密码模式修复指定目录
kitty_enc -p -f DIR

# 任意文件模式修复指定目录
kitty_enc -a FILE -f DIR
```

## 注意事项

### 文件处理规则
- **跳过空文件**（大小为 0 的文件）
- **跳过软链接**（符号链接），除非明确指定；指定软链接不会删除实际文件，除非软链接指向目录
- **跳过隐藏文件**：以 `.` 开头的目录和文件（如 `.git`）
- **跳过忽略文件**：`.kitignore` 中规定的文件
- **跳过特殊文件**：
  - 自身可执行文件
  - 密钥文件（`*.kitty_key` 和 `-k` 指定的密钥）
  - 已加密文件（`*.kitty_enc`）

### 加密相关
- **加密后缀**：`.kitty_enc`
- **默认密钥文件**：`目录名-时间.kitty_key`（生成于源目录中）
- **密钥文件后缀**：可以修改为任何后缀使用，但不使用默认后缀的密钥无法自动识别
- **密钥软链接**：密钥文件支持软链接，你需要确保链接有效，软链接无法自动识别

### 密钥查找逻辑
#### 加密时：
1. 如果指定了 `-k` 参数，则使用指定的密钥文件
2. 如果没有指定 `-k` 参数，则优先在源目录（`-s` 指定的目录）中查找现有的密钥文件
3. 如果找不到现有密钥文件，则创建新的密钥文件（生成在源目录中）

#### 解密时：
1. 如果指定了 `-k` 参数，则使用指定的密钥文件
2. 如果没有指定 `-k` 参数，则在解密目录（`-d` 指定的目录）中查找密钥文件

### 其他规则
- **密钥查找范围**：只搜索一层目录，不递归搜索子文件夹
- **文件清理**：加密后删除原始文件，解密后删除加密文件
- **密钥保护**：所有 `.kitty_key` 文件都不会被加密，无论是否是指定的密钥文件

### 密码短语
- **交互式输入**：程序会提示交互式输入密码短语，不会显示在屏幕上，也不会被终端历史记录
- **密钥文件加密**：使用密码短语时，密钥文件将存储加密的密钥；不使用密码短语时，密钥文件存储原始密钥
- **密码验证**：使用密码短语时，必须提供正确的密码短语才能解密密钥文件
- **安全性增强**：密码短语用于增强安全性，即使密钥文件泄露，没有密码短语也无法解密

### 纯密码模式 (-p)
- **直接派生密钥**：使用密码直接派生密钥，不生成密钥文件
- **密码一致性**：加密和解密都需要输入相同的密码
- **适用场景**：适用于不需要密钥文件管理的场景
- **密码强度**：密码强度直接影响安全性

### 任意文件模式 (-a)
- **文件派生密钥**：使用任意文件的内容派生密钥
- **文件大小要求**：文件必须至少32字节大小
- **读取限制**：程序会读取文件前1MB内容用于密钥派生
- **密码结合**：可以结合密码使用
- **适用场景**：适用于需要基于特定文件生成密钥的场景

### 修复模式 (-f)
- **谨慎使用**：希望永远不要用到它
- **参数要求**：使用时注意需要正确的解密参数，否则无法判断加密文件完整性

### 消息模式 (msg):
- **仅供娱乐**：用于一次性加密消息, 不应用于长期存储, 也不应用于传输消息
- **密钥安全**：如果密钥和结果同时泄露, 则明文会泄露, 必须以安全手段传递密钥
- **大小限制**：消息大小限制50KB以内
- **获取帮助**：注意所有子命令均不继承主命令参数, 子命令详细使用说明应在子命令下查看

### 编码模式 (base):
- **不保证安全性**：该模式不是加密，不提供任何安全性，不应用于任何隐私内容
- **不保证完整性**：程序不会验证文件完整性, 也不会删除原文件，且文本文件极易被修改, 程序无法保证文件不会损坏或被篡改
- **不适合归档**：编码后文件大小会增加3到4倍, 不适合用于归档
- **大小限制**：最大允许处理1GB文件
- **获取帮助**：详细使用说明请在子命令下查看

### 安全提示
- **密钥保管**：请妥善保管密钥文件，丢失密钥将无法解密文件
- **定期备份**：建议定期备份密钥文件
- **网络传输**：不要在公共网络传输未加密的密钥文件
- **密码强度**：使用强密码短语以增强安全性
- **分开保管**：密码短语和密钥文件应分开保管
- **纯密码安全**：纯密码模式下，请使用强密码并确保密码安全
- **文件稳定性**：任意文件模式下，确保使用的文件内容稳定不变，否则无法解密

### 关于内存清理: 
  - 绝大多数涉及隐私信息的内存在程序正常结束时都会被清理
  - 对于运行敏感应用程序的系统，应完全禁用休眠功能
  - 在 Unix 系统中，当在开发环境之外运行加密代码时，也应该禁用核心转储
  - 由于许多系统对进程可锁定的内存量有限制, 本程序预计会取消对内存锁定的支持, 用户有责任保护内存不被交换到磁盘
  - 如果冷启动攻击或静态数据保护是您的威胁模型中严重的问题，那么最有效的防御措施是加密整个磁盘卷并加密交换分区（或完全禁用交换分区）

### 关于正常使用:
  - 程序在处理时会尝试请求文件锁，但取决于实际情况，可能会报错、无效、被绕过、被忽略，程序无法保证锁定有效
  - 用户应当保证需要处理的文件没有被其它进程使用，否则可能造成文件损坏及其他未知后果
  - 本程序使用的后缀`kitty_enc`及`kitty_key`，不应擅自改动或使用
  - 如果有使用相同后缀的其他程序，应当自行区分文件来源
  - 不要对同一文件启动多个加密进程
  - 不要在相同目录下创建或修改与加密文件或源文件同名的文件
  - 不推荐处理软链接，因为取决于操作系统，可能产生无法预测的结果
  - 不要忽视程序的报错，谨慎使用修复模式，优先进行手动修复

### 获取帮助
```bash
# 显示完整帮助
kitty_enc --help

# 显示子命令帮助
kitty_enc encrypt --help
kitty_enc decrypt --help
kitty_enc msg --help
kitty_enc base --help
```


