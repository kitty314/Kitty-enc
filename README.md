# Kitty Enc - 文件加密工具

一个用 Rust 编写的简单的文件加密工具，支持密钥文件和纯密码两种加密模式。

## 快速开始

### 编译环境设置(有需要的话)
```powershell
$env:RUSTFLAGS="-C target-feature=+crt-static"
```

### 基本用法
```bash
kitty_enc [OPTIONS] [COMMAND]
```

## 命令(不建议使用子命令)

| 命令 | 描述 |
|------|------|
| `encrypt` | 加密模式 |
| `decrypt` | 解密模式 |
| `help` | 显示帮助信息 |

## 选项(推荐直接使用选项)

| 选项 | 参数 | 描述 |
|------|------|------|
| `-k, --key` | `<KEY_FILE>` | 密钥文件路径（可选）。如果指定，则使用该密钥文件；如果不指定，程序会自动查找或生成密钥文件 |
| `-a, --any-file` | `<FILE>` | 任意文件作为密钥源（可选）。使用指定文件的内容派生密钥，与-p同时使用表示使用密码 |
| `-s, --src` | `<DIR>` | 要加密的目录路径。加密时会优先在该目录中查找密钥文件 |
| `-d, --dec` | `<DIR>` | 要解密的目录路径。解密时会优先在该目录中查找密钥文件 |
| `-p, --passwd` | | 使用纯密码模式，不生成密钥文件，与-a同时使用表示使用密码 |
| `-f, --fix` | `<DIR>` | 要修复的目录路径。修复时会收集该目录下的所有文件进行比对 |
| `-h, --help` | | 显示帮助信息 |
| `-V, --version` | | 显示版本信息 |

## 使用示例

### 基本操作
```bash
# 无参数：在当前目录生成密钥并加密当前目录（默认使用密码短语）
kitty_enc

# 加密指定目录（优先在 DIR 中查找密钥，没有则生成，默认使用密码短语）
kitty_enc -s DIR

# 使用指定密钥加密指定目录（默认使用密码短语）
kitty_enc -k key.kitty_key -s DIR

# 显式加密指定目录（优先在 DIR 中查找密钥，没有则生成，默认使用密码短语）
kitty_enc encrypt -s DIR
```

### 解密操作
```bash
# 解密指定目录（在 DIR 中查找密钥文件，默认使用密码短语）
kitty_enc -d DIR

# 使用指定密钥解密指定目录（默认使用密码短语）
kitty_enc -k key.kitty_key -d DIR

# 显式解密指定目录（在 DIR 中查找密钥文件，默认使用密码短语）
kitty_enc decrypt -d DIR
```

### 纯密码模式
```bash
# 纯密码模式：使用密码加密当前目录（不生成密钥文件）
kitty_enc -p

# 纯密码模式：使用密码加密指定目录（不生成密钥文件）
kitty_enc -p -s DIR

# 纯密码模式：使用密码解密指定目录（不生成密钥文件）
kitty_enc -p -d DIR
```

### 任意文件模式
```bash
# 任意文件模式：使用指定文件派生密钥加密目录
kitty_enc -a FILE -s DIR

# 任意文件模式：使用指定文件派生密钥解密目录
kitty_enc -a FILE -d DIR

# 任意文件模式+密码：使用文件内容和密码派生密钥加密目录
kitty_enc -a FILE -p -s DIR

# 任意文件模式+密码：使用文件内容和密码派生密钥解密目录
kitty_enc -a FILE -p -d DIR
```

### 修复模式
```bash
# 修复指定目录
kitty_enc -f DIR

# 使用指定密钥修复指定目录
kitty_enc -k key.kitty_key -f DIR

# 纯密码模式修复指定目录
kitty_enc -p -f DIR

# 任意文件模式修复指定目录
kitty_enc -a FILE -f DIR
```

## 注意事项

### 文件处理规则
- **跳过空文件**（大小为 0 的文件）
- **跳过软链接**（符号链接），除非明确指定，指定软链接不会删除实际文件
- **跳过隐藏文件**：以 `.` 开头的目录和文件（如 `.git`）
- **跳过忽略文件**：`.kitignore` 中规定的文件
- **跳过特殊文件**：
  - 自身可执行文件
  - 密钥文件（`*.kitty_key` 和 `-k` 指定的密钥）
  - 已加密文件（`*.kitty_enc`）

### 加密相关
- **加密后缀**：`.kitty_enc`
- **默认密钥文件**：`目录名-时间.kitty_key`（生成于源目录中）
- **密钥文件后缀**：可以修改为任何后缀使用，但不使用默认后缀的密钥无法自动识别
- **密钥软链接**：密钥文件支持软链接，你需要确保链接有效，软链接无法自动识别

### 密钥查找逻辑
#### 加密时：
1. 如果指定了 `-k` 参数，则使用指定的密钥文件
2. 如果没有指定 `-k` 参数，则优先在源目录（`-s` 指定的目录）中查找现有的密钥文件
3. 如果找不到现有密钥文件，则创建新的密钥文件（生成在源目录中）

#### 解密时：
1. 如果指定了 `-k` 参数，则使用指定的密钥文件
2. 如果没有指定 `-k` 参数，则在解密目录（`-d` 指定的目录）中查找密钥文件

### 其他规则
- **密钥查找范围**：只搜索一层目录，不递归搜索子文件夹
- **文件清理**：加密后删除原始文件，解密后删除加密文件
- **密钥保护**：所有 `.kitty_key` 文件都不会被加密，无论是否是指定的密钥文件

### 密码短语
- **交互式输入**：程序会提示交互式输入密码短语，不会显示在屏幕上，也不会被终端历史记录
- **密钥文件加密**：使用密码短语时，密钥文件将存储加密的密钥；不使用密码短语时，密钥文件存储原始密钥
- **密码验证**：使用密码短语时，必须提供正确的密码短语才能解密密钥文件
- **安全性增强**：密码短语用于增强安全性，即使密钥文件泄露，没有密码短语也无法解密

### 纯密码模式 (-p)
- **直接派生密钥**：使用密码直接派生密钥，不生成密钥文件
- **密码一致性**：加密和解密都需要输入相同的密码
- **适用场景**：适用于不需要密钥文件管理的场景
- **密码强度**：密码强度直接影响安全性

### 任意文件模式 (-a)
- **文件派生密钥**：使用任意文件的内容派生密钥
- **文件大小要求**：文件必须至少32字节大小
- **读取限制**：程序会读取文件前1MB内容用于密钥派生
- **密码结合**：可以结合密码使用
- **适用场景**：适用于需要基于特定文件生成密钥的场景

### 修复模式 (-f)
- **谨慎使用**：希望永远不要用到它
- **参数要求**：使用时注意需要正确的解密参数，否则无法判断加密文件完整性

### 安全提示
- **密钥保管**：请妥善保管密钥文件，丢失密钥将无法解密文件
- **定期备份**：建议定期备份密钥文件
- **网络传输**：不要在公共网络传输未加密的密钥文件
- **密码强度**：使用强密码短语以增强安全性
- **分开保管**：密码短语和密钥文件应分开保管
- **纯密码安全**：纯密码模式下，请使用强密码并确保密码安全
- **文件稳定性**：任意文件模式下，确保使用的文件内容稳定不变，否则无法解密

### 获取帮助
```bash
# 显示完整帮助
kitty_enc --help

# 显示子命令帮助
kitty_enc encrypt --help
kitty_enc decrypt --help
```


